name: Build and Deploy Next.js App

on:
  push:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  AWS_REGION: eu-central-1

jobs:
  # ============================================
  # JOB 1: Provisionner l'infrastructure avec Terraform
  # ============================================
  terraform:
    name: Terraform Infrastructure
    runs-on: ubuntu-latest
    outputs:
      server_ip: ${{ steps.tf_output.outputs.server_ip }}

    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: Configurer AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Générer la clé SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keygen -y -f ~/.ssh/id_rsa > ~/.ssh/id_rsa.pub

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0
          terraform_wrapper: false

      - name: Terraform Init
        working-directory: ./infra
        run: terraform init

      - name: Terraform Plan
        working-directory: ./infra
        run: |
          terraform plan \
            -var="ssh_public_key=$(cat ~/.ssh/id_rsa.pub)" \
            -out=tfplan

      - name: Terraform Apply
        working-directory: ./infra
        run: terraform apply -auto-approve tfplan

      - name: Récupérer l'IP du serveur
        id: tf_output
        working-directory: ./infra
        run: |
          SERVER_IP=$(terraform output -raw instance_public_ip)
          echo "server_ip=$SERVER_IP" >> $GITHUB_OUTPUT

  # ============================================
  # JOB 2: Build de l'application Next.js (en parallèle avec Terraform)
  # ============================================
  build:
    name: Build Next.js
    runs-on: ubuntu-latest

    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Installer les dépendances
        run: npm ci

      - name: Build de l'application
        run: npm run build
        env:
          NEXT_TELEMETRY_DISABLED: 1

      - name: Préparer l'artifact
        run: |
          mkdir -p deploy
          cp -r .next deploy/
          cp -r public deploy/ 2>/dev/null || true
          cp package.json deploy/
          cp package-lock.json deploy/
          cp next.config.* deploy/ 2>/dev/null || true

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: nextjs-build
          path: deploy/
          retention-days: 1

  # ============================================
  # JOB 3: Déployer sur le serveur EC2
  # ============================================
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    needs: [terraform, build]

    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: nextjs-build
          path: deploy/

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ needs.terraform.outputs.server_ip }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Attendre que le serveur soit prêt
        run: |
          for i in {1..30}; do
            if ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 ubuntu@${{ needs.terraform.outputs.server_ip }} "echo ok" 2>/dev/null; then
              echo "Serveur prêt!"
              break
            fi
            echo "Tentative $i/30..."
            sleep 10
          done

      - name: Déployer les fichiers
        run: |
          ssh -o StrictHostKeyChecking=no ubuntu@${{ needs.terraform.outputs.server_ip }} "mkdir -p ~/app"
          scp -o StrictHostKeyChecking=no -r deploy/* ubuntu@${{ needs.terraform.outputs.server_ip }}:~/app/

      - name: Installer et démarrer l'application
        run: |
          ssh -o StrictHostKeyChecking=no ubuntu@${{ needs.terraform.outputs.server_ip }} << 'ENDSSH'
            cd ~/app
            npm ci --production
            
            # Installation PM2 si absent
            if ! command -v pm2 &> /dev/null; then
              sudo npm install -g pm2
            fi
            
            # Redémarrage de l'app
            pm2 delete nextjs-app 2>/dev/null || true
            sudo pm2 start npm --name "nextjs-app" -- start -- -p 80
            sudo pm2 startup
            sudo pm2 save
          ENDSSH

      - name: Vérification du déploiement
        run: |
          echo "Application disponible sur: http://${{ needs.terraform.outputs.server_ip }}"
          sleep 10
          curl -f --retry 3 --retry-delay 5 http://${{ needs.terraform.outputs.server_ip }} || echo "L'app démarre..."
