name: Deploy App to AWS

on:
  push:
    branches: [ main ]

jobs:
  # ÉTAPE 1 : Préparation de l'application
 # ÉTAPE 1 : Préparation de l'application
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: app/package-lock.json

      - name: Build App
        run: |
          cd app
          npm ci
          # On s'assure que le build est bien généré
          npm run build

      # --- ÉTAPE DE LISTING AJOUTÉE ---
      - name: List files for debugging
        run: |
          echo "=== Structure du dossier 'app' après le build ==="
          ls -Rla app/
          
          echo "=== Vérification de la présence de .next ==="
          if [ -d "app/.next" ]; then
            echo "✅ Le dossier .next existe et contient :"
            ls -la app/.next | head -n 10
          else
            echo "❌ ERREUR : Le dossier .next est INTROUVABLE"
          fi

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: app-bundle
          # On prend TOUT le dossier app, c'est plus sûr
          path: app/
          include-hidden-files: true
          retention-days: 1

  # ÉTAPE 2 : Infrastructure et Déploiement
  deploy:
    needs: build-and-test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          name: app-bundle
          path: my-app-files # On télécharge à la racine du runner

      - name: Verify Artifact Contents
        run: |
          echo "=== Vérification de l'artéfact téléchargé ==="
          # On liste le dossier de destination du téléchargement
          ls -Rla my-app-files/
          
          if [ -d "my-app-files/.next" ]; then
            echo "✅ SUCCÈS : Le dossier .next est présent."
          else
            echo "❌ ERREUR : .next est MANQUANT dans my-app-files/"
            exit 1
          fi

      # CORRECTIF 2 : Installer Terraform sur le runner
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_wrapper: false

      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: eu-central-1

      - name: Terraform Apply
        id: terraform
        run: |
          cd infra
          terraform init
          terraform apply -auto-approve -var="ssh_public_key=${{ secrets.SSH_PUBLIC_KEY }}"
          echo "SERVER_IP=$(terraform output -raw server_ip)" >> $GITHUB_ENV

      # --- ÉTAPE DE SÉCURITÉ AJOUTÉE ---
      - name: Wait for SSH to be ready
        run: |
          echo "Waiting for SSH on ${{ env.SERVER_IP }}..."
          timeout 300 bash -c 'until printf "" 2>>/dev/null >/dev/tcp/$0/22; do sleep 5; done' ${{ env.SERVER_IP }}
          echo "SSH is up!"

      - name: Copy files to EC2
        uses: appleboy/scp-action@master
        with:
          host: ${{ env.SERVER_IP }}
          username: ubuntu
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          # SOURCE : On prend tout ce qui est dans le dossier téléchargé
          source: "my-app-files/"
          target: "/home/ubuntu/myapp"
          # On retire le dossier 'my-app-files' au déballage sur le serveur
          strip_components: 1
          # On exclut node_modules pour éviter les corruptions (image_2df270.png)
          rm: true

      - name: Launch Application
        uses: appleboy/ssh-action@master
        with:
          host: ${{ env.SERVER_IP }}
          username: ubuntu
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /home/ubuntu/myapp
            
            # 1. Arrêter PM2 pour libérer les fichiers
            pm2 delete next-app || true
            
            # 2. Nettoyage TOTAL (On supprime tout sauf le build et les configs)
            # On ne garde que ce qui est nécessaire pour installer proprement
            find . -maxdepth 1 ! -name '.next' ! -name 'public' ! -name 'package.json' ! -name 'package-lock.json' ! -name 'next.config.mjs' ! -name '.' -exec rm -rf {} +
            rm -rf node_modules
            
            # 3. Installation fraîche sur l'architecture Linux d'AWS
            # Cela résout l'erreur de module manquant (image_498e6f.png)
            npm cache clean --force
            npm install --production
            
            # 4. Relancer proprement
            pm2 start npm --name "next-app" -- start -- -H 0.0.0.0
            pm2 save
